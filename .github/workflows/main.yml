name: iOS CI/CD

on: [push]

jobs:
  build-and-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Run Xcode Tests
        run: |
          # 1. ID direkt 체ber den Namen und das OS abfragen
          # Das ist viel weniger fehleranf채llig als manuelles Greppen
          DEVICE_ID=$(xcrun simctl list devices "iPhone 16" available | grep "18.5" | awk -F '[()]' '{print $2}' | head -n 1)
          
          # Falls das fehlschl채gt, nehmen wir einfach das allererste verf체gbare iPhone in der Liste
          if [ -z "$DEVICE_ID" ]; then
            DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -n 1 | grep -oE '[0-9A-F]{8}-([0-9A-F]{4}-){3}[0-9A-F]{12}')
          fi

          echo "Using Device ID: $DEVICE_ID"

          if [ -z "$DEVICE_ID" ]; then
            echo "Error: Still no Simulator ID found. Listing all available devices for debugging:"
            xcrun simctl list devices available
            exit 1
          fi

          # 2. Boot-Vorgang starten
          echo "Booting Simulator $DEVICE_ID..."
          xcrun simctl boot "$DEVICE_ID" || true

          # 3. Warten bis der Status "Booted" ist
          echo "Waiting for simulator to reach 'Booted' state..."
          for i in {1..20}; do
            if xcrun simctl list devices | grep "$DEVICE_ID" | grep -q "Booted"; then
              echo "Simulator is Booted!"
              break
            fi
            echo "Still booting... ($i/20)"
            sleep 5
          done

          # 4. Tests starten
          set -o pipefail && xcodebuild test \
            -project budgetPlanner.xcodeproj \
            -scheme budgetPlanner \
            -destination "id=$DEVICE_ID" \
            -resultBundlePath TestResults \
            | xcbeautify

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults


     

      # 3. Create directory for the API Key
      - name: Prepare API Key
        run: mkdir -p private_keys

      # 4. Write the secret .p8 content to a file
      - name: Create API Key File
        run: echo "${{ secrets.APP_STORE_P8_TEXT }}" > private_keys/AuthKey_${{ secrets.APP_STORE_KEY_ID }}.p8

      # 5. Archive the App (Using Generic iOS Destination)
      - name: Archive App
        run: |
          xcodebuild archive \
            -scheme budgetPlanner \
            -archivePath build/budgetPlanner.xcarchive \
            -destination 'generic/platform=iOS' \
            -authenticationKeyID ${{ secrets.APP_STORE_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_ISSUER_ID }} \
            -authenticationKeyPath $(pwd)/private_keys/AuthKey_${{ secrets.APP_STORE_KEY_ID }}.p8 \
            -allowProvisioningUpdates \
            | xcbeautify
